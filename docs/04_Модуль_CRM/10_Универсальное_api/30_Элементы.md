# Элементы

[TOC]

Элемент фабрики в Битрикс24 — это базовая единица данных, используемая для управления и автоматизации бизнес-процессов. Элементы фабрики могут представлять собой различные сущности, такие как сделки, лиды, контакты, компании и другие объекты CRM. Каждый элемент содержит набор полей и свойств, которые описывают его характеристики и состояние.

Каждый элемент описывается наследником абстраткого класса `Bitrix\Crm\Item`, например сделка описывается классом `Bitrix\Crm\Item\Deal` наследником `Bitrix\Crm\Item`.


## Получение элементов

На [фабрике](/04_Модуль_CRM/10_Универсальное_api/20_Фабрики.md) существует 4 способа для получения элементов:
- Получение объекта по идентификатору
- Получение объектов по фильтру
- Получение объектов по фильтру с учетом прав
- Низкоуровневые запросы


**Я знаю ID элемента, как мне получить объект?**

Для получения объекта по идентификатору существует метод `getItem(int $id): ?Item`.
Пример использования:

```php

$elementId = 123;

/**
 * @var \Bitrix\Crm\Item
 */
$itemObject = $factory->getItem($elementId);
```

**Я хочу найти все элементы по фильтру**

Предположим мы хотим найти все элементы по какому-то фильтру (например ID больше 10 и меньше 15).
Получить элементы можно используя метод `getItems(array $parameters = []): array`:

```php
$filter = [
    '><ID' => [10, 15],
];

$elements = $factory->getItems([
    'filter' => $filter
]);
```

Предположим, мы хотим усовершенствовать запрос и получить только те элементы которые доступны текущему пользователю - для этого можно воспользоваться методом `getItemsFilteredByPermissions`, который имеет следующую сигнатуру:

```php
public function getItemsFilteredByPermissions(
    array $parameters,
    ?int $userId = null,
    string $operation = UserPermissions::OPERATION_READ
): array
```

Используя этот метод мы можем получить не только элементы доступные текущему пользователю, но так же можем запросить еще и доступные другомому пользователю с учетом его прав на элементы.

Набор параметров `$parameters` являетися унифицированным и наиболее приближен к [параметрам ORM](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=5753&LESSON_PATH=3913.3516.5748.5063.5753), однако настоятельно не рекомендую использовать в методах поиска что-либо кроме `filter`, `order`, `limit`, `offset`, а `runtime` использовать с осторожностью.

В фильтре допустимо использовать следующие примеры:
```
= равно (работает и с массивами)
% подстрока
> больше
< меньше
@  IN (EXPR), в качестве значения передается массив или объект DB\SqlExpression
!@  NOT IN (EXPR), в качестве значения передается массив или объект DB\SqlExpression

!= не равно
!% не подстрока
>< между, в качестве значения передается массив array(MIN, MAX)
>= больше или равно
<= меньше или равно
=% LIKE
%= LIKE

Пояснение по префиксам
Префиксы %= и =% эквивалентны, все примеры для одного подходят для второго:
'%=NAME' => 'тест' - отбор строки по LIKE (НЕ ПОДСТРОКИ)
'%=NAME' => 'тест%' - отбор записей, содержащих "тест" в начале поля NAME
'%=NAME' => '%тест' - отбор записей, содержащих "тест" в конце поля NAME
'%=NAME' => '%тест%' - отбор записей, содержащих подстроку "тест" в поле NAME
Последний вариант отличается от %NAME => тест итоговым sql-запросом.
== булевое выражение для ExpressionField (например, для EXISTS() или NOT EXISTS())
!>< не между, в качестве значения передается массив array(MIN, MAX)
!=% NOT LIKE
!%= NOT LIKE
'==ID' => null - условие, что поле ID равно NULL (в sql-запросе будет преобразовано в ID IS NULL)
'!==NAME' => null - условие, что поле NAME не равно NULL (в sql-запросе будет преобразовано в NAME IS NOT NULL)
```

## Подсчет количества

Часто возникает необходимо получить только количество элементов удовлетворяющих фильтру и в таком случае запрашивать все поля элементов представляется сильно избыточным механизмом.
Для этого у фабрики есть методы `getItemsCount` и `getItemsCountFilteredByPermissions` которые находят количество элементов по фильтру и то же самое только с учетом прав.
Сигнатуры методов выглядят следующим образом:

```php
public function getItemsCount(array $filter = []): int

public function getItemsCountFilteredByPermissions(
        array $filter = [],
        ?int $userId = null,
        string $operation = UserPermissions::OPERATION_READ
    ): int
```

Пример подсчета элементов, которые начинаются в буквы "А":
```php
$filter = [
    '%=NAME' => 'A'
];

$elementCount = $factory->getItemsCount([
    'filter' => $filter
]);
```

## Создание элемента

Мы разобрали ситуацию когда элементы уже существуют, но как правильно создать элементы? Поскольку фабрика является абстрактной элемент так же является абстракцией. Чтобы получить объект необходимо использовать метод `createItem(array $data = []): Item`, при этом в ключе `$data` можно указать первоначальные значения.

Пример объекта(!) создание сделки с заранее определенным название:
```php
$newDeal = $factory->createItem([
    'TITLE' => 'New Title'
]);
```

>Важное примечание: создание объекта не создает запись в базе данных, поэтому по завершению скрипта объект будет уничтожен!

Сохранение самого элемента в базе данных выполняется при помощи [операций](/04_Модуль_CRM/10_Универсальное_api/40_Операции.md).
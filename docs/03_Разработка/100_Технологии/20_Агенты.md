# Введение

[TOC]

Агенты - технология, позволяющая запускать произвольные PHP функции (агенты) с заданной периодичностью. Технически агент - это запись в специальной таблице состоящая из: 
- выполняемого кода,
- даты выполнения,
- периода выполнения,
- каким способом назначать время следующего запуска агента (см. 'Периодические и непериодические').

Агенты и почтовые события работают на основе механизма "Фоновых заданий" и выполняются после выполнения страницы.

>До версии 20.5.0 агенты выполнялись в самом начале загрузки каждой страницы (непосредственно перед открытием сессии и событием OnPageStart) система автоматически проверяет, есть ли агент, который нуждается в запуске, и исполняет его в случае необходимости. 

## Периодические и непериодические виды агентов

Исторически агенты называются "периодические" ("точно в указанное время") и "непериодические" ("через заданный интервал"), хотя правильнее было бы сказать: "неповторяющиеся" и "повторяющиеся". Сложившиеся названия решили не менять.

### Периодические агенты

Агенты выполняющиеся "точно в указанное время", т.е. их интервал вычисляется по формуле:

```
Время назначенного следующего выполнения = Старое назначенное время агента + интервал
```

Например, раз в день запускается агент очистки старых почтовых событий или агент с ежедневным отчетом о посещаемости сайта. 

>Важное примечание: агенты выполняется строгое количество раз. Что это значит? Если агенты работают на хитах и с момента последнего хита было пропущено Н выполнений, то после подачи хитов на сайт, агент будет выполнен Н раз

>Важное примечание: На проектах с низкой посещаемостью возможна ситуация, когда большое количество агентов может тормозить работу сайта. Монитор производительности показывает низкую (в районе 1) оценку. Статистика выполнения страниц показывает время генерации от 1 секунды и больше, а некоторые страницы вообще отказываются открываться.
>При таких симптомах посмотрите внимательнее статистику выполнения страницы. Если обнаружится что 90% времени генерации страницы занимает пролог сайта, то вероятно проблема в агентах. Достаточно 5-и агентов, у которых выставлено свойство Периодический. При выставлении этого свойства система при пропуске выполнения агента в следующие разы пытается компенсировать пропуски, что приводит к перегрузке сервера.
>Решение: Выключить периодичность агентов.


### Непериодические агенты

Агенты выполняющиеся "через заданный интервал", т.е. их интервал вычисляется по формуле:
```
Время назначенного следующего выполнения = Время завершения последнего запуска + интервал
```

>Важное примечание: в отличие от периодического вида агентов в подобной ситуации агент поведет себя подругому - будет вызван только один раз.

Абсолютное большинство агентов непериодические.

## Механизмы запуска агентов

В Битрикс24 существует несколько механизмов запуска агентов:
- Выполнение всех агентов на хитах 
- Выполнение всех агентов на cron
- Комбинированный способ: непериодические агенты на `cron`, периодические на хитах (по-умолчанию для Bitrix Env)

Почему существует несколько механизмов запуска?
Битрикс24 разработан на Bitrix Framework, который имеет богатую историю и печальную славу "legacy"-кода. Механизм работы агентов на хитах был использован в тот момент, когда настройка cron была прирогативой разработчиков, а продукт позиционировался как максимально удобный для пользователя. Т.е. он должен был работать одинаково везде - и на хостинг-провайдерах и на VPS. Изначально такой независимой технологией и были - агенты, выполняемые на хитах.

Почему нельзя ультимативно перевести все на cron?
Не смотря на наличие технической возможности выполнять все на cron, некоторые задачи могут требовать более частого выполнения, в то время как минимальный интервал крона - 1 минута. К тому же не стоит забывать, что все так же есть установки на разных платформах, где cron может быть закрыт для установки. 

Подробнее о механизме запусков можно узнать в документации (см. ссылку в подвале "Запуск агентов").

## Применение

Использовать агенты удобно для выполнения любых операций связанных с повторением или фоновыми (не зависящими от пользователей) действиями.
В Битриксе агенты имеют самое разнообразное применение:
- `CUser::CleanUpAgent();` - агент удаляющий пользователей с неподтвержденной регистрацией если прошло больше Н дней после регистрации из главного модуля
- `\Bitrix\Tasks\Internals\Counter\Agent::expiredSoon(6);` - агент уведомляющий пользователя о скором окончании задач для пользователя ID:6 из модуля задач
- `CTicket::AutoClose();` - агент автоматический закрывающий задачи из модуля техподдержка
- `CCalendar::ReminderAgent(16, 1, 'https://some-portal.tech/company/personal/user/1/calendar/?EVENT_ID=16', 'user', 1, 0);` - агент отправляющий нотификацию пользователю ID:1 по событию ID:16 (`EVENT_ID`)

Как видно - агенты достаточно распространенная и широкоприменя в продукте технология, однако как и любая другая технология она имеет свои ограничения.

## Ограничения

Разработчик должен учитывать, что код который будет завернут в агент имееет достаточно много ограничений:

1. Объекта пользователя (`$USER`) в агентах нет.

Поэтому любой код, который запрашивает должен проверяться на наличие опций отключающих проверку прав.
Важно: В агентах нельзя проводить авторизацию методом `Authorize`, поскольку она может отправить cookie файлы авторизации случайному посетителю.

>Примечание: даже наличие глобальной переменной `$USER` не является гарантией того, что в этой переменной находится объект класса `CUser`

2. Отсутствует константа `SITE_ID`
Агент может выполнять не только на страницах конкретного сайта, но и на хитах в административной панели и даже в cli-режиме (например на cron)

3. На многоязычных сайтах нельзя заранее узнать какой будет язык.

4. Агенты выполняются в однопоточном режиме с блокировкой на MySQL на 10 минут.
Новый вызов агента возможен только после того, как отработает предыдущий вызов.
Блокировка БД может потеряться если закроется соединение с ней. 10 минут ожидания это - дополнительная защита от повторного запуска, агентов которые не корректно отработали.

5. В случае выполнения агентов на хитах временная точность запуска агентов напрямую зависит от равномерности и плотности посещаемости сайта. Реальное время запуска агента обычно чуть-чуть позже, чем время, на которое назначен агент (при равномерной посещаемости). Момент запуска - это когда кто-то зашел на страницу сайта.
Если вам необходимо организовать запуск каких-либо PHP функций в абсолютно точно заданное время, то необходимо воспользоваться стандартной утилитой cron, предоставляемой большинством хостингов.

6. Кроме этого, не рекомендуется вешать на агенты ресурсоёмкие операции, для них существует фоновый запуск по cron'у.


## Выбор между агентами и cron

У опытных разработчиков обычно не возникает сомнений в выборе способа реализации той или иной бизнес-функции, однако есть общие рекомендации по выбору:

1. Ресурсоемкие оперции (выполняющиеся 5+ секунд или требующие значительного объема оперативной памяти) следует выполнять отдельными `cron`-скриптами

2. Если это будет использоваться в тиражируемом модуле, то выбор стоит отдать в пользу агентов.

3. Во всех остальных случаях предпочтение стоит отдать агентам.

>Да, последний пункт является "вкусовщиной" и нет единого мнения как стоит реализовывать тот или иной код. Лично я предпочитаю использовать cron-скрипты, вместо агентов и использую последних только в тиражируемых модулях или когда это выгоднее с точки зрения времени на написание.

## API

<-- Здесь будет код для проведения манипуляции над агентами -->
<-- Создание агента -->
<-- Редактирование агента -->
<-- Удаление агента -->
<-- Получение списка агентов -->


## Дополнительная информация

[Агенты в курсе Bitrix Framework](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=3436&LESSON_PATH=3913.4619.3436)
[Агенты в Пользовательской документации](https://dev.1c-bitrix.ru/user_help/settings/settings/agent_list.php)
[Запуск агентов](https://dev.1c-bitrix.ru/learning/course/?COURSE_ID=43&LESSON_ID=2943)
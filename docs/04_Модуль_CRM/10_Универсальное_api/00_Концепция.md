# Новое универсальное API

[TOC]

Данный раздел посвящен принципиально новому подходу для работы с основными CRM сущностями. В рамках реализации [Смарт-процессов](/04_Модуль_CRM/15_Смарт_процессы/00_Описание.md) разработчики решили не просто реализовать новые возможности, но так же и переосмыслить старые идеи. В основе нового подхода лежит реализация дополнительных требований:
1. Уменьшение дублирования кода.
2. Уменьшение связности классов.
3. Покрытие тестами.

Совершенно очевидно, что сложность в изучении модуля возросла многократно, однако это компенсируется единообразием.
Планируется что изучив общий подход разработчик сможет по образу и подобию работать и с другими сущностями CRM.

>На момент написания раздела механизм используется для сущностей [смарт-процессы](/04_Модуль_CRM/15_Смарт_процессы/00_Описание.md), [счета](/04_Модуль_CRM/22_Счет.md) и [предложение](/04_Модуль_CRM/23_Предложение.md). Поддержка остальных сущностей является экспериментальной. Что это значит? Сейчас поддержка нового API является добровольной и работает в пилотном режиме, но в будущем, когда все несовместимости будут устранены этот механизм будет включен для всех сущностей принудительно, а старое поведение будет убрано из продукта.

## Концепция

В основу нового api заложены такие паттерны как: [локатор сервисов](https://ru.wikipedia.org/wiki/%D0%9B%D0%BE%D0%BA%D0%B0%D1%82%D0%BE%D1%80_%D1%81%D0%BB%D1%83%D0%B6%D0%B1), [абстрактная фабрика](https://ru.wikipedia.org/wiki/%D0%90%D0%B1%D1%81%D1%82%D1%80%D0%B0%D0%BA%D1%82%D0%BD%D0%B0%D1%8F_%D1%84%D0%B0%D0%B1%D1%80%D0%B8%D0%BA%D0%B0_(%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)), [фабрика](https://ru.wikipedia.org/wiki/%D0%A4%D0%B0%D0%B1%D1%80%D0%B8%D1%87%D0%BD%D1%8B%D0%B9_%D0%BC%D0%B5%D1%82%D0%BE%D0%B4_(%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)), [фасад](https://ru.wikipedia.org/wiki/%D0%A4%D0%B0%D1%81%D0%B0%D0%B4_(%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)) и [одиночка (singleton)](https://ru.wikipedia.org/wiki/%D0%9E%D0%B4%D0%B8%D0%BD%D0%BE%D1%87%D0%BA%D0%B0_(%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F)), поэтому крайне желательно быть с ними знакомым.

Точкой входа в весь механизм является *контейнер* - это singleton-класс который с одной стороны обеспечивает простой доступ к сервисам из [локатора сервисов](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=14032), а с другой стороны является абстрактной фабрикой для фабрик по работе с сущностями.

Мы употребили много не совсем очевидных слов поэтому давайте немного разберемся в терминологии. 

**Сервис** - объект, как правило, в единственном экземпляре, который выполняет небольшую обособленную часть логики. Поскольку они строго следуют принципу единой ответственности в модуле crm их довольно много. В продукте используется большое количество сервисов и ознакомиться с ними вы сможете в документации по продукту (см. полезные ссылки).

**Фабрика по работе с сущностью** это класс для определенной сущности, который описывает некоторую специфичную для конкретного типа особенности - например набор полей, поведение и прочее.

>Здесь и далее под словом "тип" подразумевается "тип сущности в рамках CRM", например "Лид", "Сделка" и т.д. К ним же относятся "Смарт-процессы".

Нам с вами известно, что каждая сущность имеет свои особенности работы и что нельзя просто так изменить строчку в базе данных - сохранение это сложная операция, которая затрагивает различные действия. Поэтому в продукте появилась принципиально новая механика - **Операция**. Это конфигурируемый класс, который содержит обработчики всей логики для выполнения определенного действия.

Давайте разберемся на примере - наша задача изменить существующую сделку. Идентификатор сделки известен, изменяемые поля и новые значения нам известны. Что нам нужно сделать? 
1. Из контейнера получить фабрику по работе с сущностью.
2. Из фабрики по работе с сущностью получить изменяемый элемент (объект элемента).
3. Изменить необходимые поля элемента.
4. Из фабрики по работе с сущностью получить операцию изменения.
5. Передать в операцию изменения уже измененный элемент.
6. Запустить операцию изменения.

## Полезные ссылки

[Новое API в документации 1С-Битрикс](https://dev.1c-bitrix.ru/api_d7/bitrix/crm/crm_new_api.php)
[Локатор сервисов](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&LESSON_ID=14032)
[Сервисы](https://dev.1c-bitrix.ru/api_d7/bitrix/crm/service/index.php)